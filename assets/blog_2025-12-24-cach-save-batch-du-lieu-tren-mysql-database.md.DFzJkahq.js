import{_ as i,c as a,o as s,b as n}from"./chunks/framework.CDs6etjB.js";const t=JSON.parse('{"title":"Cách Save batch dữ liệu trên mysql database","description":"Cách Save batch dữ liệu trên mysql database để không đầy Bin log và không làm lag replica mysql","frontmatter":{"footer":true,"title":"Cách Save batch dữ liệu trên mysql database","description":"Cách Save batch dữ liệu trên mysql database để không đầy Bin log và không làm lag replica mysql","authors":["lethanh"],"date":"2025-12-24T00:00:00.000Z","outline":"deep","draft":false},"headers":[{"level":2,"title":"Vấn đề gặp phải","slug":"van-đe-gap-phai","link":"#van-đe-gap-phai","children":[{"level":3,"title":"Cách thức đọc dữ liệu tại consumer hiện tại","slug":"cach-thuc-đoc-du-lieu-tai-consumer-hien-tai","link":"#cach-thuc-đoc-du-lieu-tai-consumer-hien-tai","children":[]}]},{"level":2,"title":"Vấn đề gặp phải","slug":"van-đe-gap-phai-1","link":"#van-đe-gap-phai-1","children":[]},{"level":2,"title":"Nguyên nhân","slug":"nguyen-nhan","link":"#nguyen-nhan","children":[]},{"level":2,"title":"Giải pháp","slug":"giai-phap","link":"#giai-phap","children":[{"level":3,"title":"Cách thực hiện batch insert với jdbcTeamplate.batchUpdate và JPA.","slug":"cach-thuc-hien-batch-insert-voi-jdbcteamplate-batchupdate-va-jpa","link":"#cach-thuc-hien-batch-insert-voi-jdbcteamplate-batchupdate-va-jpa","children":[{"level":4,"title":"Sử dụng jdbcTemplate.batchUpdate","slug":"su-dung-jdbctemplate-batchupdate","link":"#su-dung-jdbctemplate-batchupdate","children":[]},{"level":4,"title":"Sử dụng JPA để thực hiện batch insert","slug":"su-dung-jpa-đe-thuc-hien-batch-insert","link":"#su-dung-jpa-đe-thuc-hien-batch-insert","children":[]}]}]},{"level":2,"title":"Kết quả đạt được","slug":"ket-qua-đat-đuoc","link":"#ket-qua-đat-đuoc","children":[]}],"relativePath":"blog/2025-12-24-cach-save-batch-du-lieu-tren-mysql-database.md","filePath":"blog/2025-12-24-cach-save-batch-du-lieu-tren-mysql-database.md","lastUpdated":1766590906000}');const h=i({name:"blog/2025-12-24-cach-save-batch-du-lieu-tren-mysql-database.md"},[["render",function(i,t,h,e,l,p){return s(),a("div",null,[...t[0]||(t[0]=[n('<p>Xin chào mọi người!</p><p>Mình gần đây gặp phải 1 bài toán khá hay. Hệ thống của mình cần migration dữ liệu từ hệ thống cũ đến hệ thống mới.</p><p>Do việc migartion chứa rất nhiều logic encode..etc.. vì vậy không thể dùng các tool ETL có sẵn để làm việc này hoặc viết 1 script đơn giản để chạy 1 lần.</p><p>Vì vậy, team đã thảo luận và quyết định hệ thống cũ sẽ đọc dữ liệu trong database sau đó push lên Kafka, sau đó hệ thống mới sẽ đọc dữ liệu từ Kafka về và xử lý logic rồi lưu vào database mới.</p><p>Tuy nhiên, chúng mình có 11 tỉ bản ghi.</p><h2 id="van-đe-gap-phai" tabindex="-1">Vấn đề gặp phải <a class="header-anchor" href="#van-đe-gap-phai" aria-label="Permalink to &quot;Vấn đề gặp phải&quot;">​</a></h2><p>Lúc đầu chúng mình dự định mỗi message trong Kafka sẽ là i batch bản ghi. Ví dụ 1 batch là 1000 bản ghi, vậy mỗi message sẽ chứa 1000 bản ghi.</p><p>Tuy nhiên, kích thước mặc định của một message trong Kafka là 1MB. Và đây là Kafka của cả tập đoàn dùng chung, nên không thể thay đổi cấu hình này được.</p><p>Vì vậy, dể đơn giản hóa bài toán, chúng mình quyết định mỗi message trong Kafka sẽ là 1 bản ghi sau đó hệ thống mới sẽ đọc từng bản ghi một và lưu vào database mới.</p><h3 id="cach-thuc-đoc-du-lieu-tai-consumer-hien-tai" tabindex="-1">Cách thức đọc dữ liệu tại consumer hiện tại <a class="header-anchor" href="#cach-thuc-đoc-du-lieu-tai-consumer-hien-tai" aria-label="Permalink to &quot;Cách thức đọc dữ liệu tại consumer hiện tại&quot;">​</a></h3><p>Hiện tại phía consumer mình sử dụng Kafka batch, tức thay vì mỗi lần chỉ xử lý 1 msg duy nhất, mình sẽ xử lý 1 batch msg trong 1 lần poll từ Kafka. Hiện tại, một batch sẽ có tôi đa 500 msg.</p><h2 id="van-đe-gap-phai-1" tabindex="-1">Vấn đề gặp phải <a class="header-anchor" href="#van-đe-gap-phai-1" aria-label="Permalink to &quot;Vấn đề gặp phải&quot;">​</a></h2><p>Lúc đầu mình sử dụng JPA với method saveAll() để lưu batch dữ liệu vào database.</p><p>Mọi thứ hoạt động rất tốt, dữ liệu đầy đủ và không bị thiếu, mình nghĩ là task xong rồi.</p><p>Tuy nhiên, khi thử trên môi trường loadtest với 30 triệu dữ liệu, có 2 vấn đề vô cùng nghiêm trọng xảy ra:</p><ol><li>File Bin Log của mysql tăng rất nhanh, trung bình 1 triệu bản ghi sẽ tăng khoảng 1GB file bin log. <ul><li>Hãy nghĩ với 11 tỉ dữ liệu thì file Bin LOG sẽ là 11TB, điều này là không thể chấp nhận được.</li></ul></li><li>Replica mysql bị lag rất nặng, khi loadtest hết 30 triệu dữ liệu, Replica bị lag tới 4 giờ đồng hồ. <ul><li>Điều này ảnh hưởng nghiêm trọng đến hệ thống vì hệ thống đọc dữ liệu từ Replica.</li><li>30triệu dữ liệu chỉ là test, với 11 tỉ dữ liệu thật thì Replica sẽ lag cả năm.</li><li>Đã tăng lên 10 Thread cho Replica vẫn không giải quyết được vấn đề này.</li></ul></li></ol><h2 id="nguyen-nhan" tabindex="-1">Nguyên nhân <a class="header-anchor" href="#nguyen-nhan" aria-label="Permalink to &quot;Nguyên nhân&quot;">​</a></h2><p>Nguyên nhân chính của vấn đề này là do JPA với method saveAll() sẽ thực hiện từng câu lệnh insert một cho mỗi bản ghi trong batch.</p><p>Ví dụ với batch 500 bản ghi, JPA sẽ thực hiện 500 câu lệnh insert riêng biệt.</p><p>Điều này dẫn đến File Big log tăng rất nhanh, vì mỗi câu lệnh insert sẽ được ghi vào bin log.</p><p>Chính vì quá nhiều câu lệng insert đơn lẻ trong Bin Log nên replica cũng sẽ cần đồng bộ cho từng câu lệnh insert này, dẫn đến việc replica bị lag nghiêm trọng.</p><h2 id="giai-phap" tabindex="-1">Giải pháp <a class="header-anchor" href="#giai-phap" aria-label="Permalink to &quot;Giải pháp&quot;">​</a></h2><p>Để giải quyết vấn đề này, mình quyết định sử dụng batch insert thay vì insert từng bản ghi một. Batch insert sẽ gom nhiều bản ghi lại thành một câu lệnh insert duy nhất.</p><p>Ví dụ:</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">insert into</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> table_name (col1, col2) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (val1a, val2a), (val1b, val2b), (val1c, val2c);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Điều này sẽ giúp giảm đáng kể số lượng câu lệnh insert được ghi vào bin log, từ đó giảm kích thước file bin log và giảm tải cho replica.</p><h3 id="cach-thuc-hien-batch-insert-voi-jdbcteamplate-batchupdate-va-jpa" tabindex="-1">Cách thực hiện batch insert với jdbcTeamplate.batchUpdate và JPA. <a class="header-anchor" href="#cach-thuc-hien-batch-insert-voi-jdbcteamplate-batchupdate-va-jpa" aria-label="Permalink to &quot;Cách thực hiện batch insert với jdbcTeamplate.batchUpdate và JPA.&quot;">​</a></h3><h4 id="su-dung-jdbctemplate-batchupdate" tabindex="-1">Sử dụng jdbcTemplate.batchUpdate <a class="header-anchor" href="#su-dung-jdbctemplate-batchupdate" aria-label="Permalink to &quot;Sử dụng jdbcTemplate.batchUpdate&quot;">​</a></h4><p>Với jdbcTemplate, mình có thể sử dụng method batchUpdate để thực hiện batch insert. Với cách này chúng ta sẽ sử dụng tính năng Batch processing của JDBC với luồng như sau</p><ol><li>Tạo connection</li><li>Tạo PreparedStatement được biên dịch trên Mysql server trước.</li><li>Toàn bộ batch dữ liệu được gửi đến Database thông qua việc gọi ps.executeBatch()</li><li>Mysql thực hiện nó là 1 câu lênnh batch insert duy nhất.</li></ol><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String INSERT_ON_DUPLICATE_SQL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;&quot;</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  INSERT INTO tableMock (</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      service_id, created_at, deleted_at</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  )</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  VALUES (:serviceId, :createdAt, :deletedAt)</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ON DUPLICATE KEY UPDATE tableMock.service_id = VALUES(service_id)</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       List&lt;Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt; batchValues </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (MockEntity record </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> batchs) {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; paramMap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HashMap&lt;&gt;();</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                paramMap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;serviceId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getServiceId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                paramMap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;createdAt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCreatedAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                paramMap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deletedAt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeletedAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                batchValues.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(paramMap);</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jdbcTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batchUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(INSERT_ON_DUPLICATE_SQL,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                                    batchValues.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Tuy nhiên, do 1 số đặc thù của dự án và giới hạn của jdbcTemplate, việc sử dụng jdbcTemplate sẽ khó có thể xem metrics..etc.. nên mình quyết định sử dụng JPA để thực hiện batch insert.</p><h4 id="su-dung-jpa-đe-thuc-hien-batch-insert" tabindex="-1">Sử dụng JPA để thực hiện batch insert <a class="header-anchor" href="#su-dung-jpa-đe-thuc-hien-batch-insert" aria-label="Permalink to &quot;Sử dụng JPA để thực hiện batch insert&quot;">​</a></h4><p>Với JPA chúng ta sẽ đơn giản hơn rất nhiều, chỉ cần cấu hình 1 số thuộc tính trong file cấu hình JPA sau đó khi gọi SaveAll() thì JPA sẽ tự động gom các bản ghi lại và thực hiện batch insert.</p><p>Với JPA, chúng ta có thể cấu hình để JPA sử dụng batch insert thông qua các bước sau:</p><ol><li>Cấu hình thuộc tính hibernate.jdbc.batch_size trong file cấu hình JPA.</li></ol><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">spring.jpa.properties.hibernate.jdbc.batch_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=500</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">spring.jpa.properties.hibernate.order_inserts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">spring.jpa.properties.hibernate.order_updates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>Cấu hình Mysql JDBC driver để hỗ trợ batch insert.</li></ol><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">spring.datasource.hikari.data-source-properties.rewriteBatchedStatements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Hoặc trực tiếp trên URL kết nối:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>jdbc:mysql://localhost:3306/dbname?rewriteBatchedStatements=true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Sau khi cấu hình xong, khi gọi method saveAll() của JPA, JPA sẽ tự động gom các bản ghi lại và thực hiện batch insert.</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MockTable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; savedRecords </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mockTableepository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(batch);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Một số lưu ý khi sử dụng batch insert với JPA:</p><ol><li>Kích thước batch: Chúng ta cần cấu hình kích thước batch phù hợp với hệ thống của mình. Nếu batch quá lớn, vượt quá cấu hình <code>max_allowed_packet</code> của Mysql thì có thể sẽ bị Mysql từ chối yêu cầu. <ul><li>Sử dụng <code>SHOW VARIABLES LIKE &#39;max_allowed_packet&#39;;</code> để kiểm tra giá trị hiện tại của <code>max_allowed_packet</code>.</li></ul></li><li>Kiểm tra lại các trigger: Nếu bảng có sử dụng trigger, chúng ta cần kiểm tra lại xem trigger có hoạt động đúng với batch insert hay không.</li><li>Batch insert chỉ hỗ trợ trong cùng một transaction, nếu khác transaction thì sẽ không được gom lại.</li><li>Nên sử dụng method saveAll()</li></ol><h2 id="ket-qua-đat-đuoc" tabindex="-1">Kết quả đạt được <a class="header-anchor" href="#ket-qua-đat-đuoc" aria-label="Permalink to &quot;Kết quả đạt được&quot;">​</a></h2><p>Sau khi áp dụng batch insert, mình đã tiến hành loadtest lại với 30 triệu bản ghi và đạt được các kết quả sau:</p><ol><li>Kích thước file bin log giảm đáng kể, từ 30GB xuống còn khoảng 200Mb.</li><li>Replica không còn bị lag</li></ol>',48)])])}]]);export{t as __pageData,h as default};
